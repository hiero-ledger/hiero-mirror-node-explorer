name: "Release Explorer"
on:
  workflow_dispatch:
    inputs:
      dry-run-enabled:
        description: "Perform Dry Run"
        type: boolean
        required: false
        default: false

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  packages: write
  contents: read

jobs:
  prepare-release:
    name: Release / Prepare
    runs-on: hiero-mirror-node-linux-medium
    outputs:
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22

      - name: Install Semantic Release
        run: |
          npm install -g semantic-release@24.2.0 @semantic-release/git@10.0.1 @semantic-release/github@11.0.1 \
            @semantic-release/exec@6.0.3 semantic-release-helm3@2.9.3 \
            conventional-changelog-conventionalcommits@8.0.0 \
            @commitlint/cli@19.5.0 @commitlint/config-conventional@19.5.0 \
            marked-mangle@1.1.10 marked-gfm-heading-id@4.1.1 semantic-release-conventional-commits@3.0.0

      - name: Setup JQ
        uses: dcarbone/install-jq-action@b7ef57d46ece78760b4019dbc4080a1ba2a40b45 # v3.2.0
        with:
          version: 1.7

      - name: Calculate Next Version
        working-directory: _frontend
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        run: |
          if [[ "${{ github.event.repository.default_branch }}" == "${{ github.ref_name }}" ]]; then
            semantic-release --dry-run
          else
            if [[ "${{ inputs.dry-run-enabled }}" == "true" ]]; then
              jq -r '.version' './package.json' > VERSION
            else
              gh run cancel ${{ github.run_id }}
            fi
          fi

      - name: Retrieve Version
        working-directory: _frontend
        id: release
        run: echo "version=$(cat VERSION)" >> "${GITHUB_OUTPUT}"

  publish-container:
    name: Publish
    uses: ./.github/workflows/zxc-release-explorer-docker-container.yaml
    needs:
      - prepare-release
    with:
      new-version: ${{ needs.prepare-release.outputs.version }}
      dry-run-enabled: ${{ inputs.dry-run-enabled }}

  publish-chart:
    name: Publish
    uses: ./.github/workflows/zxc-release-explorer-helm-chart.yaml
    needs:
      - prepare-release
    with:
      new-version: ${{ needs.prepare-release.outputs.version }}
      dry-run-enabled: ${{ inputs.dry-run-enabled }}

  finalize-release:
    name: Release / Finalize
    runs-on: hiero-mirror-node-linux-medium
    needs:
      - publish-container
      - publish-chart
    if: ${{ inputs.dry-run-enabled != true }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22

      - name: Install Semantic Release
        run: |
          npm install -g semantic-release@24.2.0 @semantic-release/git@10.0.1 @semantic-release/github@11.0.1 \
            @semantic-release/exec@6.0.3 semantic-release-helm3@2.9.3 \
            conventional-changelog-conventionalcommits@8.0.0 \
            @commitlint/cli@19.5.0 @commitlint/config-conventional@19.5.0 \
            marked-mangle@1.1.10 marked-gfm-heading-id@4.1.1 semantic-release-conventional-commits@3.0.0

      - name: Finalize Release
        working-directory: _frontend
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        run: npx semantic-release
